<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Checkout - EnergiZen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <header class="bg-success text-white p-3 d-flex justify-content-between align-items-center">
    <h2 class="m-0">M√©todo de Pago</h2>
    </header>

  <div class="container mt-4">
    <h2>Resumen de Compra</h2>
    <div id="cartDetails">
      <table class="table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="cartItems"></tbody>
      </table>
      <div class="d-flex justify-content-between">
        <p>Subtotal:</p>
        <p id="subtotal">MXN $0.00</p>
      </div>
      <div class="d-flex justify-content-between">
        <p>Total:</p>
        <p id="total">MXN $0.00</p>
      </div>
    </div>

    <h2>M√©todos de Pago</h2>
    <form id="paymentForm">
      <div class="mb-3">
        <label for="paymentMethod" class="form-label">M√©todo de Pago</label>
        <select class="form-select" id="paymentMethod" required>
            <option value="cash">Seleccionar</option>
          <option value="cash">Efectivo (OXXO)</option>
          <option value="paypal">PayPal / Tarjeta de Cr√©dito o D√©bito</option>
        </select>
      </div>
      <div id="cashPaymentDetails" class="mb-3" style="display: none;">
        <p>Por favor, pague el monto total en cualquier tienda OXXO con el siguiente c√≥digo:</p>
        <p id="oxxoCode" class="fw-bold"></p>
      </div>
      <div id="paypalPaymentDetails" class="mb-3" style="display: none;">
        <p>Por favor, complete el pago mediante PayPal.</p>
        <div id="paypal-button-container"></div>
        <p id="result-message"></p>

       
        <!-- Initialize the JS-SDK -->
         <script src="https://www.paypal.com/sdk/js?client-id=ASVcURO4JqU9s9Ua5X_zmvz76KPkYn1Lq52RRrU7LA1HB5kKVZ5jI4pYS-ThnuIi7Mokcu0X9U_HuNbV"></script>
        <!-- <script
            src="https://www.paypal.com/sdk/js?client-id=ASVcURO4JqU9s9Ua5X_zmvz76KPkYn1Lq52RRrU7LA1HB5kKVZ5jI4pYS-ThnuIi7Mokcu0X9U_HuNbV&buyer-country=US&currency=USD&components=buttons&enable-funding=venmo,paylater,card"
            data-sdk-integration-source="developer-studio"
        ></script> -->
        <script src="../scripts/app.js"></script>
      </div>
      <button type="submit" class="btn btn-primary"  onclick="finalizarPedido()">
        Terminar Pedido
        </button>
    </form>
    <div id="paymentResult" class="mt-3"></div>
  </div>

  <footer class="bg-success text-white mt-5 pt-5 pb-4 custom-footer">
  <div class="container">
    <div class="row">
      <!-- Sobre EnergiZen -->
      <div class="col-md-3 mb-4">
        <h5>Sobre EnergiZen</h5>
        <p class="small">
          Promovemos un estilo de vida saludable con productos org√°nicos que apoyan tu bienestar f√≠sico y mental. Cada compra impulsa el comercio justo y la sustentabilidad.
        </p>
      </div>

      <!-- M√°s informaci√≥n -->
      <div class="col-md-3 mb-4">
        <h5>M√°s informaci√≥n</h5>
        <ul class="list-unstyled small">
          <li><a href="preguntasFrecuentes.html" class="footer-link">Preguntas frecuentes</a></li>
          <li><a href="terminos.html" class="footer-link">T√©rminos y condiciones</a></li>
          <li><a href="privacidad.html" class="footer-link">Pol√≠tica de privacidad</a></li>
        </ul>
      </div>

      <!-- Contacto -->
      <div class="col-md-3 mb-4">
        <h5>Cont√°ctanos</h5>
        <p class="small m-0">¬øTienes alguna duda?</p>
        <p class="small m-0">üìß contacto@energizen.mx</p>
        <p class="small m-0">üìç CDMX, M√©xico</p>
        <p class="small m-0">üìû +52 55 1234 5678</p>
      </div>

      <!-- Redes Sociales -->
      <div class="col-md-3 mb-4">
        <h5>S√≠guenos</h5>
        <div class="d-flex gap-3 fs-5">
          <a href="#" class="text-white"><i class="bi bi-facebook"></i></a>
          <a href="#" class="text-white"><i class="bi bi-instagram"></i></a>
          <a href="#" class="text-white"><i class="bi bi-tiktok"></i></a>
          <a href="#" class="text-white"><i class="bi bi-youtube"></i></a>
        </div>
      </div>
    </div>
    <hr class="border-light">
    <p class="text-center small m-0">¬© 2025 EnergiZen. Todos los derechos reservados.</p>
  </div>
</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const carrito = JSON.parse(localStorage.getItem("carrito")) || [];

    function displayCartDetails() {
        let subtotal = 0; // usamos let porque se va a modificar
        const impuestos = 0; // puedes calcular impuestos si lo necesitas
        const usuario = localStorage.getItem("usuarioActivo");

        const conteo = {};
        carrito.forEach(id => conteo[id] = (conteo[id] || 0) + 1);

        const productos = JSON.parse(localStorage.getItem("productos")) || [];

        const listaProductos = Object.keys(conteo).map(id => {
            const prod = productos.find(p => p.product_id === parseInt(id));
            return {
            nombre: prod.name,
            cantidad: conteo[id],
            precio: prod.price
            };
        });

        const cartItems = document.getElementById("cartItems");
        const subtotalElement = document.getElementById("subtotal");
        const totalElement = document.getElementById("total");

        cartItems.innerHTML = ""; // limpiamos la tabla

        listaProductos.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${item.nombre}</td>
            <td>MXN $${item.precio.toFixed(2)}</td>
            <td>${item.cantidad}</td>
            <td>MXN $${(item.precio * item.cantidad).toFixed(2)}</td>
            `;
            cartItems.appendChild(row);
            subtotal += item.precio * item.cantidad;
        });

        descuentoAplicado = localStorage.getItem('descuento')
        subtotal_last = subtotal.toFixed(2) - (subtotal*descuentoAplicado)
        subtotalElement.textContent = subtotal_last.toFixed(2);
        totalElement.textContent = (subtotal_last + subtotal_last * 0.16).toFixed(2);
        localStorage.setItem('totalForPayPal', (subtotal_last + subtotal_last * 0.16).toFixed(2))

    }

    function generateOXXOCode() {
      const code = Math.floor(1000000000000000 + Math.random() * 9000000000000000);
      document.getElementById('oxxoCode').textContent = code;
    }

    document.getElementById('paymentMethod').addEventListener('change', function() {
      const cashPaymentDetails = document.getElementById('cashPaymentDetails');
      const paypalPaymentDetails = document.getElementById('paypalPaymentDetails');

      cashPaymentDetails.style.display = 'none';
      paypalPaymentDetails.style.display = 'none';

      if (this.value === 'cash') {
        cashPaymentDetails.style.display = 'block';
        generateOXXOCode();
      } else if (this.value === 'card') {
        cardPaymentDetails.style.display = 'block';
      } else if (this.value === 'paypal') {
        paypalPaymentDetails.style.display = 'block';
      }
    });

    document.getElementById('paymentForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const paymentMethod = document.getElementById('paymentMethod').value;

      if (paymentMethod === 'cash') {
        displayResult('Pago exitoso. Por favor, pague en OXXO con el c√≥digo proporcionado.', 'text-success');
      } else if (paymentMethod === 'paypal') {
        displayResult('Pago exitoso mediante PayPal', 'text-success');
      }
    });

    function displayResult(message, className) {
      const resultDiv = document.getElementById('paymentResult');
      resultDiv.innerHTML = `<p class="${className}">${message}</p>`;
    }

    // Display cart details on page load
    displayCartDetails();

    function finalizarPedido() {
        const usuario = localStorage.getItem("usuarioActivo");
        const productos = JSON.parse(localStorage.getItem("productos")) || [];
        const carrito = JSON.parse(localStorage.getItem("carrito")) || [];

        const conteo = {};
        carrito.forEach(id => conteo[id] = (conteo[id] || 0) + 1);

        const listaProductos = Object.keys(conteo).map(id => {
            const prod = productos.find(p => p.product_id === parseInt(id));
            return {
            nombre: prod.name,
            cantidad: conteo[id],
            precio: prod.price
            };
        });

        let subtotal = 0;
        listaProductos.forEach(item => {
            subtotal += item.precio * item.cantidad;
        });

        const impuestos = subtotal * 0.16;
        const total = subtotal + impuestos;

        const ticket = {
            user_id: usuario,
            payment_method_id: document.getElementById("paymentMethod").value,
            status_id: "Completado",
            product_list: listaProductos,
            total_price: total,
            created_data: new Date().toLocaleDateString(),
            ticket_id: Date.now()
        };

        // Guardar en historial general
        const tickets = JSON.parse(localStorage.getItem("tickets")) || [];
        tickets.push(ticket);
        localStorage.setItem("tickets", JSON.stringify(tickets));

        // Guardar en historial de compras por usuario
        const compras = JSON.parse(localStorage.getItem("compras")) || {};
        if (!compras[usuario]) compras[usuario] = [];
        compras[usuario].push(`${ticket.created_data}: $${total.toFixed(2)} - ${listaProductos.length} productos`);
        localStorage.setItem("compras", JSON.stringify(compras));

        // Guardar ticket detallado para vista de ticket
        localStorage.setItem("ultimoTicket", JSON.stringify({
            ticket_id: ticket.ticket_id,
            productos: listaProductos,
            subtotal: subtotal,
            impuestos: impuestos,
            total: total,
            fecha: ticket.created_data,
            metodoPago: ticket.payment_method_id
        }));

        // Limpiar carrito
        localStorage.removeItem("carrito");

        alert("¬°Compra finalizada exitosamente!");
        window.location.href = "ticket.html";
        }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</body>
</html>